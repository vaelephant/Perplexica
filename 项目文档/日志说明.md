# 日志系统说明文档

## 📋 概述

为了便于排查问题，我们在关键位置添加了详细的日志输出。所有日志都带有前缀标识，方便在控制台中过滤和查看。

## 🏷️ 日志前缀标识

所有日志都使用以下前缀格式：`[模块名]`

### 主要模块

- **`[UPLOAD]`** - 文件上传处理
- **`[CHAT]`** - 聊天请求处理
- **`[RERANK]`** - 文档重新排序和相似度计算
- **`[PROCESS_DOCS]`** - 文档内容处理
- **`[CONTEXT]`** - 上下文构建
- **`[FILE_DETAILS]`** - 文件详情获取

---

## 📍 日志位置

### 1. 文件上传 (`src/app/api/uploads/route.ts`)

#### 上传开始
```
[UPLOAD] ===== 开始处理文件上传 =====
[UPLOAD] 上传文件数量: X
[UPLOAD] Embedding Model: 已提供/未提供
[UPLOAD] Embedding Provider: 已提供/未提供
```

#### 文件处理
```
[UPLOAD] 处理文件: 文件名
[UPLOAD]   类型: document/image/other
[UPLOAD]   扩展名: pdf/docx/jpg...
[UPLOAD]   文件ID: xxxxx
[UPLOAD]   保存路径: /path/to/file
[UPLOAD]   文件已保存
```

#### 文档处理
```
[UPLOAD]   开始处理文档: document 类型
[UPLOAD]   使用 PDFLoader/DocxLoader 加载文件...
[UPLOAD]   加载成功，共 X 页/块
[UPLOAD]   开始分割文档，原始块数: X
[UPLOAD]   文档分割完成，分割后块数: X
[UPLOAD]   提取的内容已保存: /path/to/extracted.json
[UPLOAD]   内容块数量: X
[UPLOAD]   开始生成嵌入向量...
[UPLOAD]   嵌入向量生成完成，向量数量: X
[UPLOAD]   嵌入向量已保存: /path/to/embeddings.json
[UPLOAD]   文档处理完成
```

#### 完成
```
[UPLOAD] ===== 所有文件处理完成 =====
[UPLOAD] 返回文件列表: [...]
```

---

### 2. 聊天请求 (`src/app/api/chat/route.ts`)

#### 请求开始
```
[CHAT] ===== 开始处理聊天请求 =====
[CHAT] 消息内容: ...
[CHAT] 聊天ID: xxxxx
[CHAT] 焦点模式: webSearch/writingAssistant/...
[CHAT] 优化模式: speed/balanced/quality
[CHAT] 上传的文件ID: [...]
[CHAT] 历史消息数量: X
```

#### 模型加载
```
[CHAT] 加载模型...
[CHAT] 聊天模型 Provider ID: xxxxx
[CHAT] 聊天模型 Key: xxxxx
[CHAT] 嵌入模型 Provider ID: xxxxx
[CHAT] 嵌入模型 Key: xxxxx
[CHAT] 模型加载完成
```

#### 处理流程
```
[CHAT] 用户消息ID: xxxxx
[CHAT] 历史消息处理完成，消息数量: X
[CHAT] 开始搜索和回答...
[CHAT] 传递给处理器的文件ID: [...]
[CHAT] 搜索和回答完成，开始流式返回
```

---

### 3. 文档重新排序 (`src/lib/search/metaSearchAgent.ts`)

#### 开始处理
```
[RERANK] ===== 开始处理文件内容 =====
[RERANK] 接收到的 fileIds: [...]
[RERANK] 接收到的 docs 数量: X
[RERANK] 查询内容: ...
```

#### 文件处理
```
[RERANK] 处理文件ID: xxxxx
[RERANK]   查找路径: /path/to/file
[RERANK]   内容文件: /path/to/extracted.json
[RERANK]   向量文件: /path/to/embeddings.json
[RERANK]   内容文件存在: true/false
[RERANK]   向量文件存在: true/false
```

#### 文件读取
```
[RERANK]   读取内容文件...
[RERANK]   内容文件读取成功，标题: xxxxx
[RERANK]   内容块数量: X
[RERANK]   读取向量文件...
[RERANK]   向量文件读取成功
[RERANK]   向量数量: X
[RERANK]   文件 xxxxx 处理成功，返回 X 个对象
```

#### 相似度计算
```
[RERANK] 文件数据处理完成，有效的文件数据对象数量: X
[RERANK] 过滤后的有效文档数量: X (原始: X)
[RERANK] 优化模式: speed/balanced
[RERANK] 处理 X 个文件数据对象
[RERANK] 生成查询向量...
[RERANK] 查询向量生成完成
[RERANK] 计算相似度，阈值: 0.3
[RERANK] 相似度计算结果数量: X
[RERANK] 相似度范围: 0.xxxx - 0.xxxx
[RERANK] 过滤后的文档数量: X (阈值: 0.3)
[RERANK] 最终返回文档数量: X
```

---

### 4. 文档内容处理 (`src/lib/search/metaSearchAgent.ts`)

#### 处理开始
```
[PROCESS_DOCS] ===== 开始处理文档内容 =====
[PROCESS_DOCS] 文档数量: X
[PROCESS_DOCS] 文件ID数量: X
[PROCESS_DOCS] 文件ID列表: [...]
```

#### 警告信息
```
[PROCESS_DOCS] 警告: 有文件上传但文档内容为空
[PROCESS_DOCS] 文件ID列表: [...]
[PROCESS_DOCS] 生成的提示文本长度: X
```

#### 完成
```
[PROCESS_DOCS] ===== 文档内容处理完成 =====
[PROCESS_DOCS] 最终文本长度: X
```

---

### 5. 上下文构建 (`src/lib/search/metaSearchAgent.ts`)

```
[CONTEXT] ===== 开始构建上下文 =====
[CONTEXT] 查询: ...
[CONTEXT] 文件ID: [...]
[CONTEXT] 是否搜索网络: true/false
[CONTEXT] 执行网络搜索... / 跳过网络搜索
[CONTEXT] 网络搜索结果，文档数量: X
[CONTEXT] 开始重新排序文档...
[CONTEXT] 重新排序完成，返回文档数量: X
[CONTEXT] ===== 上下文构建完成 =====
```

---

### 6. 文件详情获取 (`src/lib/utils/files.ts`)

```
[FILE_DETAILS] 获取文件详情: xxxxx
[FILE_DETAILS] 检查提取文件: /path/to/extracted.json
[FILE_DETAILS] 提取文件存在，读取中...
[FILE_DETAILS] 文件详情获取成功: 文件名
```

或

```
[FILE_DETAILS] 提取文件不存在，可能是非文档文件
[FILE_DETAILS] 在上传目录中查找原始文件...
[FILE_DETAILS] 找到原始文件: 文件名
```

---

## 🔍 如何使用日志排查问题

### 1. 查看服务器日志

所有日志都会输出到服务器控制台。如果使用 Docker，可以通过以下命令查看：

```bash
docker logs perplexica
```

### 2. 过滤特定模块的日志

在日志中搜索特定前缀：

```bash
# 查看上传相关日志
docker logs perplexica | grep "\[UPLOAD\]"

# 查看聊天相关日志
docker logs perplexica | grep "\[CHAT\]"

# 查看文档处理日志
docker logs perplexica | grep "\[RERANK\]"
```

### 3. 常见问题排查

#### 问题：文件上传失败
```
查看: [UPLOAD] 开头的日志
重点关注: 错误信息、文件保存路径、文档处理过程
```

#### 问题：文档内容没有被加载
```
查看: [RERANK] 和 [PROCESS_DOCS] 日志
重点关注:
- 文件ID是否正确传递
- 提取文件是否存在
- 内容块数量是否为0
- 相似度计算结果
```

#### 问题：聊天请求失败
```
查看: [CHAT] 开头的日志
重点关注: 模型加载、文件ID传递、错误信息
```

---

## 📊 日志级别

当前使用的日志级别：

- **`console.log()`** - 正常流程信息
- **`console.warn()`** - 警告信息（不影响功能）
- **`console.error()`** - 错误信息（功能失败）

---

## 🛠️ 调试建议

### 1. 启用详细日志

所有日志都已默认启用，无需额外配置。

### 2. 查看完整流程

当遇到问题时，按时间顺序查看日志：

1. `[UPLOAD]` - 文件是否成功上传和处理
2. `[CHAT]` - 请求是否正确接收
3. `[CONTEXT]` - 上下文是否正确构建
4. `[RERANK]` - 文档是否正确加载
5. `[PROCESS_DOCS]` - 最终内容是否正确处理

### 3. 关键检查点

- ✅ 文件ID格式是否正确
- ✅ 提取文件和向量文件是否存在
- ✅ 内容块数量是否为0
- ✅ 相似度计算是否正常
- ✅ 文档是否被过滤掉

---

## 📝 日志示例

### 成功的文档上传和处理

```
[UPLOAD] ===== 开始处理文件上传 =====
[UPLOAD] 上传文件数量: 1
[UPLOAD] 处理文件: document.docx
[UPLOAD]   类型: document
[UPLOAD]   文件ID: 36d2bc4cd3b6770c3a9199103ce4585b
[UPLOAD]   使用 DocxLoader 加载 DOCX 文件...
[UPLOAD]   DOCX 加载成功，共 1 个文档块
[UPLOAD]   文档分割完成，分割后块数: 4
[UPLOAD]   嵌入向量生成完成，向量数量: 4
[UPLOAD]   文档处理完成
[UPLOAD] ===== 所有文件处理完成 =====
```

### 文档内容加载

```
[RERANK] ===== 开始处理文件内容 =====
[RERANK] 接收到的 fileIds: ['36d2bc4cd3b6770c3a9199103ce4585b']
[RERANK] 处理文件ID: 36d2bc4cd3b6770c3a9199103ce4585b
[RERANK]   内容文件存在: true
[RERANK]   向量文件存在: true
[RERANK]   内容文件读取成功，标题: document.docx
[RERANK]   内容块数量: 4
[RERANK]   向量数量: 4
[RERANK]   文件 36d2bc4cd3b6770c3a9199103ce4585b 处理成功，返回 4 个对象
[RERANK] 文件数据处理完成，有效的文件数据对象数量: 4
```

---

## ⚙️ 日志配置建议

### 生产环境

建议保留错误和警告日志，可以适当减少详细日志。

### 开发环境

保持所有日志开启，便于调试。

---

## 🔗 相关文档

- [文件上传改造完成总结](./文件上传改造完成总结.md)
- [项目结构说明](./项目结构说明.md)

---

**提示**: 如果遇到问题，先查看日志，大部分问题都可以通过日志找到原因！

