# Perplexica 项目结构说明文档

## 项目概述

Perplexica 是一个**隐私优先的 AI 问答引擎**，完全运行在用户自己的硬件上。它结合了互联网知识和本地大语言模型（Ollama）以及云服务提供商（OpenAI、Claude、Groq），提供准确的答案和引用来源，同时保持搜索的完全私密性。

## 技术栈

- **前端框架**: Next.js 15 (App Router)
- **UI 库**: React 18, Tailwind CSS
- **数据库**: SQLite (使用 Drizzle ORM)
- **AI/ML**: LangChain, 多种 LLM 提供商
- **搜索引擎**: SearXNG
- **部署**: Docker, Docker Compose
- **语言**: TypeScript

## 目录结构详解

### 根目录

```
Perplexica/
├── src/                    # 源代码目录
├── public/                 # 静态资源
├── data/                   # 数据目录（配置、数据库）
├── uploads/                # 用户上传文件目录
├── searxng/               # SearXNG 配置文件
├── drizzle/               # 数据库迁移文件
├── docs/                  # 项目文档
├── docker-compose.yaml    # Docker Compose 配置
├── Dockerfile             # Docker 镜像构建文件
├── Dockerfile.slim        # 精简版 Docker 镜像
├── package.json           # 项目依赖配置
└── next.config.mjs        # Next.js 配置
```

### 核心源代码结构 (`src/`)

#### 1. `src/app/` - Next.js App Router 目录

Next.js 15 的 App Router 结构，包含页面和 API 路由。

##### 页面 (`src/app/`)

- **`page.tsx`** - 首页，显示聊天窗口
- **`layout.tsx`** - 根布局组件，包含主题提供者、侧边栏等
- **`c/[chatId]/page.tsx`** - 特定聊天会话页面
- **`discover/page.tsx`** - 发现页面，显示新闻和趋势内容
- **`library/page.tsx`** - 资料库页面
- **`globals.css`** - 全局样式文件

##### API 路由 (`src/app/api/`)

所有后端 API 端点：

- **`chat/route.ts`** - 处理聊天交互，执行搜索和生成回答
- **`search/route.ts`** - 提供直接搜索 API，用于程序化访问
- **`chats/route.ts`** - 获取所有聊天列表
- **`chats/[id]/route.ts`** - 获取特定聊天会话的详细信息
- **`config/route.ts`** - 配置管理 API（GET/POST）
- **`config/setup-complete/route.ts`** - 标记设置完成
- **`providers/route.ts`** - 获取可用的模型提供商列表
- **`providers/[id]/route.ts`** - 管理特定提供商（添加、更新、删除）
- **`providers/[id]/models/route.ts`** - 获取特定提供商的模型列表
- **`images/route.ts`** - 图像搜索 API
- **`videos/route.ts`** - 视频搜索 API
- **`weather/route.ts`** - 天气信息 API
- **`discover/route.ts`** - 发现页面的新闻 API
- **`suggestions/route.ts`** - 搜索建议 API
- **`uploads/route.ts`** - 文件上传处理

#### 2. `src/components/` - React 组件

##### 核心组件

- **`Chat.tsx`** - 聊天界面主组件
- **`ChatWindow.tsx`** - 聊天窗口容器
- **`MessageBox.tsx`** - 消息显示组件
- **`MessageInput.tsx`** - 消息输入框
- **`Sidebar.tsx`** - 侧边栏（聊天历史）
- **`Navbar.tsx`** - 导航栏
- **`Layout.tsx`** - 布局组件

##### 功能组件

- **`Citation.tsx`** - 引用来源显示
- **`MessageSources.tsx`** - 消息来源列表
- **`EmptyChat.tsx`** - 空聊天状态
- **`ThinkBox.tsx`** - 思考过程显示
- **`DeleteChat.tsx`** - 删除聊天对话框

##### 消息操作 (`MessageActions/`)

- **`Copy.tsx`** - 复制消息功能
- **`Rewrite.tsx`** - 重写消息功能

##### 输入操作 (`MessageInputActions/`)

- **`Attach.tsx`** / **`AttachSmall.tsx`** - 附件上传
- **`ChatModelSelector.tsx`** - 聊天模型选择器
- **`Copilot.tsx`** - Copilot 模式（开发中）
- **`Focus.tsx`** - 焦点模式选择器
- **`Optimization.tsx`** - 优化模式选择器（速度/平衡/质量）

##### 设置组件 (`Settings/`)

- **`SettingsDialogue.tsx`** - 设置对话框
- **`SettingsButton.tsx`** / **`SettingsButtonMobile.tsx`** - 设置按钮
- **`SettingsField.tsx`** - 设置字段组件
- **`Sections/`** - 设置页面各节
  - **`Preferences.tsx`** - 偏好设置
  - **`Personalization.tsx`** - 个性化设置
  - **`Search.tsx`** - 搜索设置
  - **`Models/`** - 模型管理组件

##### 其他组件

- **`Setup/`** - 初始设置向导
  - **`SetupWizard.tsx`** - 设置向导主组件
  - **`SetupConfig.tsx`** - 配置设置组件
- **`Discover/`** - 发现页面组件
  - **`MajorNewsCard.tsx`** - 主要新闻卡片
  - **`SmallNewsCard.tsx`** - 小新闻卡片
- **`SearchImages.tsx`** - 图像搜索组件
- **`SearchVideos.tsx`** - 视频搜索组件
- **`WeatherWidget.tsx`** - 天气小组件
- **`NewsArticleWidget.tsx`** - 新闻文章小组件
- **`theme/`** - 主题相关
  - **`Provider.tsx`** - 主题提供者
  - **`Switcher.tsx`** - 主题切换器
- **`ui/`** - UI 组件库
  - **`Loader.tsx`** - 加载指示器
  - **`Select.tsx`** - 选择组件

#### 3. `src/lib/` - 核心业务逻辑

##### 配置管理 (`config/`)

- **`index.ts`** - 配置管理器，负责读取、保存配置
- **`types.ts`** - 配置相关的 TypeScript 类型定义
- **`clientRegistry.ts`** - 客户端配置注册表
- **`serverRegistry.ts`** - 服务端配置注册表

配置文件路径：`data/config.json`

##### 数据库 (`db/`)

- **`schema.ts`** - 数据库模式定义
  - `messages` 表 - 存储聊天消息
  - `chats` 表 - 存储聊天会话
- **`index.ts`** - 数据库连接和初始化
- **`migrate.ts`** - 数据库迁移工具

使用 Drizzle ORM 和 SQLite

##### 模型管理 (`models/`)

- **`registry.ts`** - 模型注册表，管理所有模型提供商
- **`types.ts`** - 模型相关类型定义
- **`providers/`** - 各提供商实现
  - **`baseProvider.ts`** - 基础提供商抽象类
  - **`ollama.ts`** - Ollama 本地模型支持
  - **`openai.ts`** - OpenAI 支持
  - **`anthropic.ts`** - Anthropic Claude 支持
  - **`gemini.ts`** - Google Gemini 支持
  - **`groq.ts`** - Groq 支持
  - **`deepseek.ts`** - DeepSeek 支持
  - **`lmstudio.ts`** - LM Studio 支持
  - **`lemonade.ts`** - Lemonade 支持
  - **`transformers.ts`** - Transformers.js 支持
  - **`aiml.ts`** - AIML 支持
  - **`index.ts`** - 提供商导出

##### 搜索功能 (`search/`)

- **`index.ts`** - 导出所有搜索处理器
  - `webSearch` - 通用网络搜索
  - `academicSearch` - 学术搜索（arXiv, Google Scholar, PubMed）
  - `writingAssistant` - 写作助手（不搜索网络）
  - `wolframAlphaSearch` - Wolfram Alpha 计算
  - `youtubeSearch` - YouTube 视频搜索
  - `redditSearch` - Reddit 讨论搜索
- **`metaSearchAgent.ts`** - 元搜索代理，核心搜索逻辑

##### 提示词 (`prompts/`)

- **`index.ts`** - 提示词导出
- **`webSearch.ts`** - 网络搜索相关提示词
- **`writingAssistant.ts`** - 写作助手提示词

##### 链式处理 (`chains/`)

LangChain 链定义：

- **`imageSearchAgent.ts`** - 图像搜索代理
- **`suggestionGeneratorAgent.ts`** - 建议生成代理
- **`videoSearchAgent.ts`** - 视频搜索代理

##### 输出解析器 (`outputParsers/`)

- **`lineOutputParser.ts`** - 行输出解析器
- **`listLineOutputParser.ts`** - 列表行输出解析器

##### 工具函数 (`utils/`)

- **`computeSimilarity.ts`** - 相似度计算（余弦相似度）
- **`documents.ts`** - 文档处理工具
- **`files.ts`** - 文件处理工具
- **`formatHistory.ts`** - 历史记录格式化

##### 其他核心文件

- **`searxng.ts`** - SearXNG 搜索引擎封装
- **`serverUtils.ts`** - 服务端工具函数
- **`utils.ts`** - 通用工具函数
- **`actions.ts`** - 服务端操作
- **`hooks/useChat.tsx`** - 聊天相关的 React Hook

#### 4. `src/instrumentation.ts`

Next.js 检测配置文件，用于应用初始化

### 配置文件

#### `package.json`

项目依赖包括：
- **Next.js 15** - Web 框架
- **React 18** - UI 库
- **LangChain** - AI 链式处理
- **Drizzle ORM** - 数据库 ORM
- **Tailwind CSS** - CSS 框架
- **Axios** - HTTP 客户端
- **PDF 解析** - pdf-parse, mammoth 等
- **其他 UI 库** - Headless UI, Framer Motion, Lucide Icons

#### `next.config.mjs`

Next.js 配置：
- 输出模式：standalone
- 外部包：pdf-parse
- 图片远程模式配置

#### `drizzle.config.ts`

Drizzle ORM 配置，定义数据库连接和迁移

#### `tailwind.config.ts`

Tailwind CSS 配置，包含自定义主题和样式

### 数据目录

#### `data/`

- **`config.json`** - 应用配置文件（JSON 格式）
  - 版本号
  - 设置完成状态
  - 用户偏好
  - 个性化设置
  - 模型提供商配置
  - 搜索引擎配置
- **`db.sqlite`** - SQLite 数据库文件

#### `uploads/`

用户上传的文件存储目录（PDF、图片、文档等）

### SearXNG 配置 (`searxng/`)

- **`settings.yml`** - SearXNG 主配置文件
- **`limiter.toml`** - 速率限制配置
- **`uwsgi.ini`** - uWSGI 服务器配置
- **`docker-compose.yml`** - SearXNG Docker 配置（可选）

### Docker 配置

#### `Dockerfile`

多阶段构建：
1. **Builder 阶段**：安装依赖、构建 Next.js 应用
2. **运行阶段**：安装 SearXNG 及其依赖，配置运行环境

包含 Perplexica 和 SearXNG，作为完整解决方案

#### `Dockerfile.slim`

精简版镜像，不包含 SearXNG，需要外部 SearXNG 实例

#### `docker-compose.yaml`

Docker Compose 配置：
- 端口映射：3000（应用）、8080（SearXNG）
- 数据卷：`perplexica-data`、`perplexica-uploads`

#### `entrypoint.sh`

容器启动脚本，同时启动 Perplexica 和 SearXNG

### 文档目录 (`docs/`)

- **`architecture/`** - 架构文档
  - **`README.md`** - 架构概述
  - **`WORKING.md`** - 工作原理详解
- **`API/`** - API 文档
  - **`SEARCH.md`** - 搜索 API 文档
- **`installation/`** - 安装文档
  - **`UPDATING.md`** - 更新指南

## 核心功能模块

### 1. 搜索系统

- **元搜索代理** (`MetaSearchAgent`)：核心搜索逻辑
- **多种焦点模式**：6 种专用搜索模式
- **结果重排序**：使用嵌入模型和余弦相似度
- **搜索引擎集成**：SearXNG 作为底层搜索引擎

### 2. AI 模型管理

- **多提供商支持**：OpenAI、Anthropic、Google、Groq、Ollama 等
- **模型注册表**：统一管理所有提供商
- **动态加载**：运行时加载和切换模型
- **本地模型支持**：Ollama、LM Studio、Transformers.js

### 3. 聊天系统

- **流式响应**：实时流式传输回答
- **历史记录**：SQLite 数据库存储
- **文件上传**：支持 PDF、图片、文档
- **引用来源**：自动标注信息来源

### 4. 配置系统

- **JSON 配置**：存储在 `data/config.json`
- **环境变量支持**：从环境变量读取配置
- **UI 配置界面**：完整的设置页面
- **配置验证**：配置字段验证和迁移

### 5. 用户界面

- **响应式设计**：移动端和桌面端适配
- **主题切换**：明暗主题支持
- **实时更新**：流式更新和状态管理
- **组件化架构**：可复用的 React 组件

## 工作流程

### 搜索和回答流程

1. **用户输入查询** → `MessageInput` 组件
2. **发送到 API** → `/api/chat` 路由
3. **选择搜索处理器** → 根据焦点模式选择对应的 `MetaSearchAgent`
4. **生成搜索查询** → 使用 LLM 优化查询（如果需要）
5. **执行搜索** → 调用 SearXNG API
6. **重排序结果** → 使用嵌入模型计算相似度
7. **生成回答** → 使用 LLM 基于搜索结果生成回答
8. **流式返回** → 逐步返回生成的文本
9. **保存历史** → 存储到数据库

### 配置流程

1. **首次启动** → 检测 `setupComplete` 标志
2. **显示设置向导** → `SetupWizard` 组件
3. **配置提供商** → 添加 API 密钥和模型
4. **配置搜索引擎** → 设置 SearXNG URL
5. **保存配置** → 写入 `data/config.json`
6. **标记完成** → 设置 `setupComplete = true`

## 数据流

### 配置数据流

```
环境变量 → ConfigManager → data/config.json → 客户端/服务端
```

### 聊天数据流

```
用户输入 → API 路由 → 搜索代理 → SearXNG → 结果重排序 → LLM 生成 → 流式返回 → 数据库保存
```

### 模型数据流

```
Config JSON → ModelRegistry → Provider Instances → LangChain Models → API
```

## 关键概念

### 焦点模式 (Focus Modes)

6 种专用搜索模式：
1. **webSearch** - 通用网络搜索
2. **academicSearch** - 学术论文搜索
3. **writingAssistant** - 写作助手（无网络搜索）
4. **wolframAlphaSearch** - 数学计算
5. **youtubeSearch** - 视频搜索
6. **redditSearch** - 讨论搜索

### 优化模式 (Optimization Modes)

控制性能和质量的平衡：
- **speed** - 快速模式
- **balanced** - 平衡模式（默认）
- **quality** - 质量模式（开发中）

### 模型提供商

每个提供商需要：
- 类型标识（如 `ollama`、`openai`）
- 配置信息（API URL、API Key 等）
- 模型列表（聊天模型、嵌入模型）

## 部署方式

### Docker（推荐）

```bash
docker run -d -p 3000:3000 \
  -v perplexica-data:/home/perplexica/data \
  -v perplexica-uploads:/home/perplexica/uploads \
  --name perplexica \
  itzcrazykns1337/perplexica:latest
```

### 本地开发

```bash
npm install
npm run build
npm run start
```

## 开发建议

1. **配置文件**：所有配置都通过 `ConfigManager` 管理
2. **数据库**：使用 Drizzle ORM，迁移文件在 `drizzle/` 目录
3. **API 路由**：遵循 Next.js App Router 约定
4. **组件**：保持组件小而专注，可复用
5. **类型安全**：充分利用 TypeScript 类型系统
6. **错误处理**：所有 API 路由都应包含错误处理

## 扩展点

### 添加新的搜索模式

1. 在 `src/lib/search/index.ts` 中添加新的 `MetaSearchAgent` 实例
2. 在 `src/components/MessageInputActions/Focus.tsx` 中添加 UI 选项
3. 更新类型定义和 API 验证

### 添加新的模型提供商

1. 在 `src/lib/models/providers/` 创建新的提供商文件
2. 实现 `BaseModelProvider` 接口
3. 在 `src/lib/models/providers/index.ts` 注册
4. 在 `src/lib/config/index.ts` 添加配置字段

### 添加新的 API 端点

1. 在 `src/app/api/` 创建新的路由文件
2. 实现 GET/POST 等 HTTP 方法
3. 添加错误处理和验证

---

**文档版本**: 1.0  
**最后更新**: 2024  
**维护者**: Perplexica 开发团队

