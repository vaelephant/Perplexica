# 文件上传功能改造 - 快速开始

## 🎯 目标

**支持任意文件类型上传**（特别是图片），同时保持现有文档处理功能不变。

---

## ⚡ 最简改造方案（5分钟）

### 第一步：前端 - 移除文件类型限制

#### 修改 `src/components/MessageInputActions/Attach.tsx`

**第91行和第149行：**
```typescript
// 修改前
accept=".pdf,.docx,.txt"

// 修改后
accept="*/*"
// 或者明确列出图片格式
accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.webp,.gif"
```

#### 修改 `src/components/MessageInputActions/AttachSmall.tsx`

**第91行和第147行：同样的修改**

---

### 第二步：后端 - 移除类型检查

#### 修改 `src/app/api/uploads/route.ts`

**删除第52-57行的类型限制检查：**
```typescript
// 删除这段代码
if (!['pdf', 'docx', 'txt'].includes(fileExtension!)) {
  return NextResponse.json(
    { message: 'File type not supported' },
    { status: 400 },
  );
}
```

**修改文件处理逻辑，添加类型判断：**
```typescript
// 在第51行之后添加
const fileExtension = file.name.split('.').pop()?.toLowerCase();

// 判断是否为文档类型
const isDocument = ['pdf', 'docx', 'txt'].includes(fileExtension || '');

// 只有文档类型才需要处理文本和向量化
if (isDocument) {
  // 现有的文档处理逻辑（文本提取+向量化）
  // ...
} else {
  // 其他文件类型（如图片）仅保存，不做处理
  // 文件已经在上面的代码中保存了
}
```

---

## ✅ 完成！

经过这两步，系统就能：
- ✅ 接受任意文件类型上传
- ✅ 文档类型正常处理（文本提取+向量化）
- ✅ 其他类型（图片等）仅保存文件

---

## 🎨 后续优化（可选）

### 1. 添加图片预览

创建 `src/components/ImagePreview.tsx`：
```typescript
import Image from 'next/image';

export default function ImagePreview({ fileId, fileName }: { fileId: string; fileName: string }) {
  const imageUrl = `/api/files/${fileId}`; // 需要创建文件访问API
  
  return (
    <Image src={imageUrl} alt={fileName} width={200} height={200} />
  );
}
```

### 2. 区分文件类型显示

在文件列表中使用不同的图标：
- 📄 文档：文档图标
- 🖼️ 图片：图片预览

### 3. 文件访问API

创建 `src/app/api/files/[fileId]/route.ts` 用于访问上传的文件。

---

## 📋 完整改造清单

### 必须改动（核心功能）
- [ ] `Attach.tsx` - 修改 accept 属性
- [ ] `AttachSmall.tsx` - 修改 accept 属性  
- [ ] `api/uploads/route.ts` - 删除类型检查，添加分支处理

### 可选优化（提升体验）
- [ ] 添加文件类型判断工具函数
- [ ] 创建图片预览组件
- [ ] 创建文件访问API
- [ ] 优化文件列表显示

---

## 🔍 关键代码位置

| 文件 | 行号 | 修改内容 |
|------|------|----------|
| `Attach.tsx` | 91, 149 | `accept` 属性 |
| `AttachSmall.tsx` | 91, 147 | `accept` 属性 |
| `api/uploads/route.ts` | 52-57 | 删除类型检查 |
| `api/uploads/route.ts` | 51后 | 添加类型判断 |

---

## ⚠️ 注意事项

1. **向后兼容**：现有文档处理逻辑保持不变
2. **Embedding Model**：图片文件不需要，可以设为可选
3. **文件大小**：建议添加文件大小限制（如 50MB）
4. **安全性**：图片文件直接保存，注意路径安全

---

## 🚀 测试步骤

1. 上传 PDF 文档 → 应该正常工作（现有功能）
2. 上传 JPG 图片 → 应该可以上传（新功能）
3. 上传其他文件类型 → 应该可以上传

---

**就这么简单！** 先完成核心改造，后续再逐步优化UI和功能。

