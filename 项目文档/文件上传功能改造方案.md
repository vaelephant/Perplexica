# æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ”¹é€ æ–¹æ¡ˆ - æ”¯æŒä»»æ„æ–‡ä»¶ç±»å‹

## ğŸ“‹ ç°çŠ¶åˆ†æ

### å½“å‰é™åˆ¶

1. **æ–‡ä»¶ç±»å‹é™åˆ¶**
   - å‰ç«¯ï¼š`accept=".pdf,.docx,.txt"` åªèƒ½é€‰æ‹©è¿™3ç§æ ¼å¼
   - åç«¯ï¼šåªå¤„ç† `['pdf', 'docx', 'txt']` æ ¼å¼

2. **å¤„ç†æ–¹å¼**
   - æ‰€æœ‰æ–‡ä»¶éƒ½éœ€è¦ embedding modelï¼ˆåµŒå…¥æ¨¡å‹ï¼‰
   - æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¿›è¡Œæ–‡æœ¬æå–å’Œå‘é‡åŒ–
   - è¿™ç§å¤„ç†æ–¹å¼ä¸é€‚åˆå›¾ç‰‡ç­‰éæ–‡æ¡£æ–‡ä»¶

3. **æ–‡ä»¶æ˜¾ç¤º**
   - æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¾ç¤ºä¸ºç›¸åŒçš„æ–‡ä»¶å›¾æ ‡
   - æ²¡æœ‰å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

---

## ğŸ¯ æ”¹é€ ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡
1. âœ… **æ”¯æŒä»»æ„æ–‡ä»¶ç±»å‹ä¸Šä¼ **ï¼ˆå›¾ç‰‡ã€æ–‡æ¡£ã€å…¶ä»–ï¼‰
2. âœ… **åŒºåˆ†æ–‡ä»¶ç±»å‹**ï¼Œé‡‡ç”¨ä¸åŒçš„å¤„ç†æ–¹å¼
3. âœ… **å›¾ç‰‡æ–‡ä»¶é¢„è§ˆ**åŠŸèƒ½
4. âœ… **å‘åå…¼å®¹**ç°æœ‰æ–‡æ¡£å¤„ç†é€»è¾‘

---

## ğŸ—ï¸ æ”¹é€ æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

```
æ–‡ä»¶ä¸Šä¼ 
    â†“
æ–‡ä»¶ç±»å‹æ£€æµ‹
    â†“
åˆ†æ”¯å¤„ç†ï¼š
â”œâ”€â”€ æ–‡æ¡£ç±»ï¼ˆpdf, docx, txtï¼‰
â”‚   â””â”€â”€ æ–‡æœ¬æå– + å‘é‡åŒ–ï¼ˆç°æœ‰é€»è¾‘ï¼‰
â””â”€â”€ å›¾ç‰‡ç±»ï¼ˆjpg, png, jpeg, webpï¼‰
    â””â”€â”€ ä»…ä¿å­˜å›¾ç‰‡ï¼ˆåç»­OCRè¯†åˆ«ï¼‰
â””â”€â”€ å…¶ä»–ç±»å‹
    â””â”€â”€ ä»…ä¿å­˜æ–‡ä»¶ï¼ˆä¸åšå¤„ç†ï¼‰
```

---

## ğŸ“ è¯¦ç»†æ”¹é€ æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰©å±•æ–‡ä»¶ç±»å‹æ”¯æŒ

#### 1.1 å‰ç«¯ç»„ä»¶ä¿®æ”¹

**ä¿®æ”¹æ–‡ä»¶ï¼š`src/components/MessageInputActions/Attach.tsx`**

```typescript
// ä¿®æ”¹å‰
accept=".pdf,.docx,.txt"

// ä¿®æ”¹åï¼ˆæ–¹æ¡ˆ1ï¼šæ¥å—æ‰€æœ‰æ–‡ä»¶ï¼‰
accept="*/*"

// ä¿®æ”¹åï¼ˆæ–¹æ¡ˆ2ï¼šæ˜ç¡®åˆ—å‡ºæ”¯æŒçš„ç±»å‹ï¼‰
accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.webp,.gif,.bmp"
```

**åŒæ ·ä¿®æ”¹ï¼š`src/components/MessageInputActions/AttachSmall.tsx`**

#### 1.2 æ–‡ä»¶ç±»å‹å®šä¹‰

åˆ›å»ºæ–‡ä»¶ç±»å‹å¸¸é‡ï¼š
```typescript
// src/lib/utils/fileTypes.ts

export const DOCUMENT_TYPES = ['pdf', 'docx', 'txt'];
export const IMAGE_TYPES = ['jpg', 'jpeg', 'png', 'webp', 'gif', 'bmp'];
export const ALL_SUPPORTED_TYPES = [...DOCUMENT_TYPES, ...IMAGE_TYPES];

export function getFileType(fileExtension: string): 'document' | 'image' | 'other' {
  if (DOCUMENT_TYPES.includes(fileExtension.toLowerCase())) {
    return 'document';
  }
  if (IMAGE_TYPES.includes(fileExtension.toLowerCase())) {
    return 'image';
  }
  return 'other';
}
```

---

### ç¬¬äºŒæ­¥ï¼šåç«¯APIæ”¹é€ 

#### 2.1 ä¿®æ”¹ä¸Šä¼ APIé€»è¾‘

**ä¿®æ”¹æ–‡ä»¶ï¼š`src/app/api/uploads/route.ts`**

**å…³é”®æ”¹åŠ¨ï¼š**

1. **ç§»é™¤æ–‡ä»¶ç±»å‹é™åˆ¶æ£€æŸ¥**
   ```typescript
   // åˆ é™¤è¿™æ®µé™åˆ¶ä»£ç 
   if (!['pdf', 'docx', 'txt'].includes(fileExtension!)) {
     return NextResponse.json(
       { message: 'File type not supported' },
       { status: 400 },
     );
   }
   ```

2. **æ ¹æ®æ–‡ä»¶ç±»å‹åˆ†æ”¯å¤„ç†**
   ```typescript
   const fileType = getFileType(fileExtension);
   
   if (fileType === 'document') {
     // ç°æœ‰é€»è¾‘ï¼šæ–‡æœ¬æå– + å‘é‡åŒ–
     // éœ€è¦ embedding model
   } else if (fileType === 'image') {
     // æ–°é€»è¾‘ï¼šä»…ä¿å­˜å›¾ç‰‡
     // ä¸éœ€è¦ embedding model
   } else {
     // å…¶ä»–ç±»å‹ï¼šä»…ä¿å­˜æ–‡ä»¶
     // ä¸åšå¤„ç†
   }
   ```

3. **å¯é€‰ï¼šå›¾ç‰‡æ–‡ä»¶ä¸å¼ºåˆ¶éœ€è¦ embedding model**
   ```typescript
   // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œembedding model æ˜¯å¯é€‰çš„
   if (fileType !== 'document' && !embedding_model) {
     // å›¾ç‰‡å¯ä»¥æ²¡æœ‰ embedding model
   }
   ```

---

#### 2.2 å®Œæ•´çš„APIæ”¹é€ ç¤ºä¾‹

```typescript
// src/app/api/uploads/route.ts

export async function POST(req: Request) {
  try {
    const formData = await req.formData();
    const files = formData.getAll('files') as File[];
    const embedding_model = formData.get('embedding_model_key') as string;
    const embedding_model_provider = formData.get('embedding_model_provider_id') as string;

    const processedFiles: FileRes[] = [];

    await Promise.all(
      files.map(async (file: any) => {
        const fileExtension = file.name.split('.').pop()?.toLowerCase();
        if (!fileExtension) {
          return;
        }

        const fileType = getFileType(fileExtension);
        const uniqueFileName = `${crypto.randomBytes(16).toString('hex')}.${fileExtension}`;
        const filePath = path.join(uploadDir, uniqueFileName);

        // ä¿å­˜æ–‡ä»¶
        const buffer = Buffer.from(await file.arrayBuffer());
        fs.writeFileSync(filePath, new Uint8Array(buffer));

        if (fileType === 'document') {
          // æ–‡æ¡£å¤„ç†ï¼šæ–‡æœ¬æå– + å‘é‡åŒ–
          if (!embedding_model || !embedding_model_provider) {
            throw new Error('Embedding model required for documents');
          }

          const registry = new ModelRegistry();
          const model = await registry.loadEmbeddingModel(
            embedding_model_provider,
            embedding_model
          );

          // æå–æ–‡æœ¬
          let docs: any[] = [];
          if (fileExtension === 'pdf') {
            const loader = new PDFLoader(filePath);
            docs = await loader.load();
          } else if (fileExtension === 'docx') {
            const loader = new DocxLoader(filePath);
            docs = await loader.load();
          } else if (fileExtension === 'txt') {
            const text = fs.readFileSync(filePath, 'utf-8');
            docs = [
              new Document({ pageContent: text, metadata: { title: file.name } }),
            ];
          }

          // æ–‡æœ¬åˆ†å‰²å’Œå‘é‡åŒ–
          const splitted = await splitter.splitDocuments(docs);
          
          // ä¿å­˜æå–çš„æ–‡æœ¬
          const extractedDataPath = filePath.replace(/\.\w+$/, '-extracted.json');
          fs.writeFileSync(
            extractedDataPath,
            JSON.stringify({
              title: file.name,
              contents: splitted.map((doc) => doc.pageContent),
            }),
          );

          // ç”ŸæˆåµŒå…¥å‘é‡
          const embeddings = await model.embedDocuments(
            splitted.map((doc) => doc.pageContent),
          );
          const embeddingsDataPath = filePath.replace(/\.\w+$/, '-embeddings.json');
          fs.writeFileSync(
            embeddingsDataPath,
            JSON.stringify({
              title: file.name,
              embeddings,
            }),
          );

        } else if (fileType === 'image') {
          // å›¾ç‰‡å¤„ç†ï¼šä»…ä¿å­˜ï¼Œä¸å¤„ç†
          // åç»­å¯ä»¥é€šè¿‡OCRè¯†åˆ«
          // è¿™é‡Œä¸åšä»»ä½•å¤„ç†ï¼Œåªä¿å­˜æ–‡ä»¶
        }
        // å…¶ä»–ç±»å‹ä¹Ÿä»…ä¿å­˜æ–‡ä»¶

        processedFiles.push({
          fileName: file.name,
          fileExtension: fileExtension,
          fileId: uniqueFileName.replace(/\.\w+$/, ''),
          fileType: fileType, // æ–°å¢å­—æ®µ
        });
      }),
    );

    return NextResponse.json({
      files: processedFiles,
    });
  } catch (error) {
    console.error('Error uploading file:', error);
    return NextResponse.json(
      { message: 'An error has occurred.' },
      { status: 500 },
    );
  }
}
```

---

### ç¬¬ä¸‰æ­¥ï¼šå‰ç«¯æ˜¾ç¤ºä¼˜åŒ–

#### 3.1 æ‰©å±•æ–‡ä»¶æ•°æ®ç»“æ„

**ä¿®æ”¹æ–‡ä»¶ç±»å‹å®šä¹‰ï¼š**
```typescript
// src/components/ChatWindow.tsx æˆ–ç›¸å…³ç±»å‹å®šä¹‰æ–‡ä»¶

interface File {
  fileName: string;
  fileExtension: string;
  fileId: string;
  fileType?: 'document' | 'image' | 'other'; // æ–°å¢
  fileUrl?: string; // æ–°å¢ï¼šæ–‡ä»¶è®¿é—®URL
}
```

#### 3.2 æ·»åŠ å›¾ç‰‡é¢„è§ˆç»„ä»¶

**åˆ›å»ºæ–°ç»„ä»¶ï¼š`src/components/ImagePreview.tsx`**

```typescript
import Image from 'next/image';

export default function ImagePreview({ 
  fileId, 
  fileName 
}: { 
  fileId: string;
  fileName: string;
}) {
  // æ„å»ºå›¾ç‰‡URL
  const imageUrl = `/api/files/${fileId}`;
  
  return (
    <div className="relative w-full max-w-md">
      <Image
        src={imageUrl}
        alt={fileName}
        width={400}
        height={300}
        className="rounded-lg object-contain"
      />
    </div>
  );
}
```

#### 3.3 ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º

**ä¿®æ”¹ `Attach.tsx` ä¸­çš„æ–‡ä»¶æ˜¾ç¤ºéƒ¨åˆ†ï¼š**

```typescript
{files.map((file, i) => (
  <div key={i} className="flex flex-row items-center justify-start w-full space-x-3 p-3">
    {file.fileType === 'image' ? (
      // å›¾ç‰‡é¢„è§ˆ
      <ImagePreview fileId={file.fileId} fileName={file.fileName} />
    ) : (
      // æ–‡æ¡£å›¾æ ‡
      <div className="bg-light-100 dark:bg-dark-100 flex items-center justify-center w-10 h-10 rounded-md">
        <File size={16} className="text-black/70 dark:text-white/70" />
      </div>
    )}
    <p className="text-black/70 dark:text-white/70 text-sm">
      {file.fileName.length > 25
        ? file.fileName.replace(/\.\w+$/, '').substring(0, 25) + '...' + file.fileExtension
        : file.fileName}
    </p>
  </div>
))}
```

#### 3.4 æ·»åŠ æ–‡ä»¶è®¿é—®APIï¼ˆç”¨äºå›¾ç‰‡é¢„è§ˆï¼‰

**åˆ›å»ºæ–°è·¯ç”±ï¼š`src/app/api/files/[fileId]/route.ts`**

```typescript
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

export async function GET(
  req: Request,
  { params }: { params: { fileId: string } }
) {
  try {
    const uploadDir = path.join(process.cwd(), 'uploads');
    
    // æŸ¥æ‰¾æ–‡ä»¶ï¼ˆå¯èƒ½éœ€è¦éå†æˆ–ç»´æŠ¤æ–‡ä»¶æ˜ å°„ï¼‰
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…å¯èƒ½éœ€è¦æ”¹è¿›
    
    // è¿”å›æ–‡ä»¶æµ
    // ...
  } catch (error) {
    return NextResponse.json(
      { message: 'File not found' },
      { status: 404 }
    );
  }
}
```

---

### ç¬¬å››æ­¥ï¼šæ–‡ä»¶ç±»å‹å›¾æ ‡ä¼˜åŒ–

#### 4.1 æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡

```typescript
import { File, Image as ImageIcon, FileText } from 'lucide-react';

function getFileIcon(fileType: string, fileExtension: string) {
  if (fileType === 'image') {
    return <ImageIcon size={16} className="text-blue-400" />;
  }
  
  switch (fileExtension) {
    case 'pdf':
      return <FileText size={16} className="text-red-400" />;
    case 'docx':
      return <FileText size={16} className="text-blue-400" />;
    case 'txt':
      return <FileText size={16} className="text-gray-400" />;
    default:
      return <File size={16} className="text-gray-400" />;
  }
}
```

---

## ğŸ”„ æ”¹é€ æ­¥éª¤æ€»ç»“

### é˜¶æ®µ1ï¼šåŸºç¡€æ”¹é€ ï¼ˆç§»é™¤é™åˆ¶ï¼‰

1. âœ… **å‰ç«¯**ï¼šä¿®æ”¹ `accept` å±æ€§ï¼Œå…è®¸æ‰€æœ‰æ–‡ä»¶ç±»å‹
   - `Attach.tsx` ç¬¬91è¡Œå’Œç¬¬149è¡Œ
   - `AttachSmall.tsx` ç¬¬91è¡Œå’Œç¬¬147è¡Œ

2. âœ… **åç«¯**ï¼šç§»é™¤æ–‡ä»¶ç±»å‹é™åˆ¶æ£€æŸ¥
   - `src/app/api/uploads/route.ts` ç¬¬52-57è¡Œåˆ é™¤

3. âœ… **æµ‹è¯•**ï¼šéªŒè¯å¯ä»¥ä¸Šä¼ ä»»æ„æ–‡ä»¶ç±»å‹

---

### é˜¶æ®µ2ï¼šåˆ†ç±»å¤„ç†

1. âœ… **åˆ›å»ºæ–‡ä»¶ç±»å‹å·¥å…·å‡½æ•°**
   - æ–°å»º `src/lib/utils/fileTypes.ts`

2. âœ… **åç«¯åˆ†æ”¯å¤„ç†**
   - æ–‡æ¡£ï¼šæ–‡æœ¬æå– + å‘é‡åŒ–ï¼ˆç°æœ‰é€»è¾‘ï¼‰
   - å›¾ç‰‡ï¼šä»…ä¿å­˜æ–‡ä»¶
   - å…¶ä»–ï¼šä»…ä¿å­˜æ–‡ä»¶

3. âœ… **ä¿®æ”¹è¿”å›æ•°æ®ç»“æ„**
   - æ·»åŠ  `fileType` å­—æ®µ

---

### é˜¶æ®µ3ï¼šUIä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. âœ… **å›¾ç‰‡é¢„è§ˆåŠŸèƒ½**
   - åˆ›å»º `ImagePreview` ç»„ä»¶
   - åˆ›å»ºæ–‡ä»¶è®¿é—®API

2. âœ… **æ–‡ä»¶å›¾æ ‡ä¼˜åŒ–**
   - æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡

3. âœ… **æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºä¼˜åŒ–**
   - å›¾ç‰‡æ˜¾ç¤ºç¼©ç•¥å›¾
   - æ–‡æ¡£æ˜¾ç¤ºå›¾æ ‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘åå…¼å®¹
- âœ… ç°æœ‰æ–‡æ¡£å¤„ç†é€»è¾‘ä¿æŒä¸å˜
- âœ… ç°æœ‰æ–‡ä»¶IDå’Œå­˜å‚¨æ–¹å¼ä¸å˜
- âœ… å›¾ç‰‡æ–‡ä»¶ä¸ç”ŸæˆåµŒå…¥å‘é‡ï¼ˆèŠ‚çœèµ„æºï¼‰

### 2. æ–‡ä»¶å¤§å°é™åˆ¶
- å»ºè®®æ·»åŠ æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆå¦‚ï¼šå•æ–‡ä»¶ â‰¤ 50MBï¼‰
- åœ¨ `POST` å¤„ç†ä¸­éªŒè¯

### 3. å®‰å…¨æ€§
- éªŒè¯æ–‡ä»¶æ‰©å±•åï¼ˆé˜²æ­¢æ¶æ„æ–‡ä»¶ï¼‰
- é™åˆ¶æ–‡ä»¶å¤§å°
- æ–‡ä»¶å­˜å‚¨è·¯å¾„å®‰å…¨

### 4. æ€§èƒ½ä¼˜åŒ–
- å›¾ç‰‡æ–‡ä»¶ä¸ä¸Šä¼  embedding modelï¼ˆèŠ‚çœAPIè°ƒç”¨ï¼‰
- å›¾ç‰‡å¤„ç†å¼‚æ­¥è¿›è¡Œ
- å¤§æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º

---

## ğŸ“Š æ”¹é€ å‰åå¯¹æ¯”

| åŠŸèƒ½ | æ”¹é€ å‰ | æ”¹é€ å |
|------|--------|--------|
| æ”¯æŒæ–‡ä»¶ç±»å‹ | ä»… PDF, DOCX, TXT | æ‰€æœ‰æ–‡ä»¶ç±»å‹ |
| å›¾ç‰‡æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒä¸Šä¼ å’Œé¢„è§ˆ |
| Embedding Model | å¿…éœ€ | æ–‡æ¡£å¿…éœ€ï¼Œå›¾ç‰‡å¯é€‰ |
| æ–‡ä»¶å¤„ç† | å…¨éƒ¨æ–‡æœ¬æå–+å‘é‡åŒ– | æ ¹æ®ç±»å‹åˆ†æ”¯å¤„ç† |
| æ–‡ä»¶æ˜¾ç¤º | ç»Ÿä¸€æ–‡ä»¶å›¾æ ‡ | å›¾ç‰‡é¢„è§ˆ+åˆ†ç±»å›¾æ ‡ |

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

### ç¬¬ä¸€æ­¥ï¼šåŸºç¡€æ”¹é€ 
- [ ] ä¿®æ”¹å‰ç«¯ `accept` å±æ€§ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰
- [ ] ç§»é™¤åç«¯æ–‡ä»¶ç±»å‹é™åˆ¶
- [ ] æµ‹è¯•ä¸Šä¼ åŠŸèƒ½

### ç¬¬äºŒæ­¥ï¼šåˆ†ç±»å¤„ç†
- [ ] åˆ›å»ºæ–‡ä»¶ç±»å‹å·¥å…·å‡½æ•°
- [ ] å®ç°æ–‡ä»¶ç±»å‹æ£€æµ‹
- [ ] å®ç°åˆ†æ”¯å¤„ç†é€»è¾‘
- [ ] æµ‹è¯•ä¸åŒç±»å‹æ–‡ä»¶ä¸Šä¼ 

### ç¬¬ä¸‰æ­¥ï¼šUIä¼˜åŒ–
- [ ] åˆ›å»ºå›¾ç‰‡é¢„è§ˆç»„ä»¶
- [ ] åˆ›å»ºæ–‡ä»¶è®¿é—®API
- [ ] ä¼˜åŒ–æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
- [ ] æµ‹è¯•å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ€ç®€å•çš„æ”¹é€ ï¼ˆ5åˆ†é’Ÿï¼‰

1. **å‰ç«¯ä¿®æ”¹**ï¼šç§»é™¤æ–‡ä»¶ç±»å‹é™åˆ¶
   ```typescript
   // Attach.tsx å’Œ AttachSmall.tsx
   accept="*/*"  // æ”¹ä¸ºæ¥å—æ‰€æœ‰æ–‡ä»¶
   ```

2. **åç«¯ä¿®æ”¹**ï¼šåˆ é™¤ç±»å‹æ£€æŸ¥
   ```typescript
   // src/app/api/uploads/route.ts
   // åˆ é™¤ç¬¬52-57è¡Œçš„ç±»å‹æ£€æŸ¥ä»£ç 
   ```

3. **æµ‹è¯•**ï¼šä¸Šä¼ ä»»æ„æ–‡ä»¶ç±»å‹ï¼ŒéªŒè¯å¯ä»¥ä¿å­˜

è¿™æ ·å°±èƒ½æ”¯æŒä»»æ„æ–‡ä»¶ä¸Šä¼ äº†ï¼åç»­å¯ä»¥é€æ­¥ä¼˜åŒ–UIå’Œå¤„ç†é€»è¾‘ã€‚

---

**å»ºè®®**ï¼šå…ˆå®Œæˆç¬¬ä¸€æ­¥åŸºç¡€æ”¹é€ ï¼ŒéªŒè¯åŠŸèƒ½åï¼Œå†é€æ­¥æ·»åŠ åˆ†ç±»å¤„ç†å’ŒUIä¼˜åŒ–ã€‚

