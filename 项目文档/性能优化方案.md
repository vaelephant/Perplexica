# æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ - è§£å†³é¡µé¢è·³è½¬æ…¢çš„é—®é¢˜

## ðŸ” é—®é¢˜åˆ†æž

ä»Žä»£ç åˆ†æžä¸­å‘çŽ°ä»¥ä¸‹æ€§èƒ½ç“¶é¢ˆï¼š

### 1. å¼ºåˆ¶åŠ¨æ€æ¸²æŸ“
- `src/app/layout.tsx` ä¸­æœ‰ `export const dynamic = 'force-dynamic'`
- è¿™ä¼šç¦ç”¨æ‰€æœ‰é™æ€ä¼˜åŒ–ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°æ¸²æŸ“

### 2. é…ç½®æ£€æŸ¥æ¯æ¬¡éƒ½è°ƒç”¨ API
- `checkConfig` å‡½æ•°æ¯æ¬¡é¡µé¢åŠ è½½éƒ½ä¼šè°ƒç”¨ `/api/providers`
- æ²¡æœ‰ç¼“å­˜æœºåˆ¶ï¼Œé‡å¤è¯·æ±‚ç›¸åŒæ•°æ®

### 3. å¼€å‘æ¨¡å¼ç¼–è¯‘
- Next.js å¼€å‘æ¨¡å¼ä¸‹ï¼Œè·¯ç”±å˜åŒ–ä¼šè§¦å‘é‡æ–°ç¼–è¯‘
- å¤§é¡¹ç›®å¯èƒ½å¯¼è‡´æ¯æ¬¡è·³è½¬éƒ½å¾ˆæ…¢

### 4. å¤§é‡çš„ useEffect å’ŒçŠ¶æ€æ›´æ–°
- ChatProvider ä¸­æœ‰å¤šä¸ª useEffect ä¾èµ–
- å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡æ¸²æŸ“

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¼˜åŒ–é…ç½®æ£€æŸ¥ï¼ˆæ·»åŠ ç¼“å­˜ï¼‰

**é—®é¢˜**ï¼š`checkConfig` æ¯æ¬¡éƒ½è°ƒç”¨ API

**è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘ API è°ƒç”¨

```typescript
// åœ¨ checkConfig ä¸­æ·»åŠ ç¼“å­˜æœºåˆ¶
let configCache: { providers: any[]; timestamp: number } | null = null;
const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜

const checkConfig = async (...) => {
  // æ£€æŸ¥ç¼“å­˜
  if (configCache && Date.now() - configCache.timestamp < CACHE_DURATION) {
    // ä½¿ç”¨ç¼“å­˜æ•°æ®
    const providers = configCache.providers;
    // ... å¤„ç†é€»è¾‘
    return;
  }
  
  // è°ƒç”¨ API
  const res = await fetch(`/api/providers`);
  const data = await res.json();
  
  // æ›´æ–°ç¼“å­˜
  configCache = {
    providers: data.providers,
    timestamp: Date.now(),
  };
  // ... å¤„ç†é€»è¾‘
};
```

### æ–¹æ¡ˆ 2: ä¼˜åŒ–åŠ¨æ€æ¸²æŸ“è®¾ç½®

**é—®é¢˜**ï¼š`force-dynamic` ç¦ç”¨æ‰€æœ‰ä¼˜åŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼šåªåœ¨éœ€è¦çš„åœ°æ–¹ä½¿ç”¨åŠ¨æ€æ¸²æŸ“

```typescript
// ç§»é™¤ layout.tsx ä¸­çš„ force-dynamic
// åªåœ¨éœ€è¦åŠ¨æ€æ•°æ®çš„é¡µé¢ä½¿ç”¨
```

### æ–¹æ¡ˆ 3: ä¼˜åŒ– Next.js é…ç½®

**é—®é¢˜**ï¼šå¼€å‘æ¨¡å¼ä¸‹è·¯ç”±ç¼–è¯‘æ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜åŒ– Next.js é…ç½®

```javascript
// next.config.mjs
const nextConfig = {
  // å¯ç”¨ SWC æœ€å°åŒ–
  swcMinify: true,
  
  // ä¼˜åŒ–ç¼–è¯‘
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production',
  },
  
  // ä¼˜åŒ–å›¾ç‰‡åŠ è½½
  images: {
    // ... çŽ°æœ‰é…ç½®
  },
  
  // ä¼˜åŒ–å®žéªŒæ€§åŠŸèƒ½
  experimental: {
    optimizePackageImports: ['lucide-react'],
  },
};
```

### æ–¹æ¡ˆ 4: ä¼˜åŒ– ChatProvider

**é—®é¢˜**ï¼šå¤šä¸ª useEffect å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡æ¸²æŸ“

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åˆå¹¶ç›¸å…³çš„ useEffect
- ä½¿ç”¨ useMemo ä¼˜åŒ–è®¡ç®—
- æ·»åŠ ä¾èµ–é¡¹æ£€æŸ¥

### æ–¹æ¡ˆ 5: æ·»åŠ é¡µé¢åŠ è½½ä¼˜åŒ–

**é—®é¢˜**ï¼šé¡µé¢åˆ‡æ¢æ—¶æ²¡æœ‰åŠ è½½çŠ¶æ€ä¼˜åŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ Next.js çš„ loading.tsx
- æ·»åŠ  Suspense è¾¹ç•Œ
- ä¼˜åŒ–é¦–å±åŠ è½½

---

## ðŸš€ å¿«é€Ÿä¼˜åŒ–ï¼ˆç«‹å³å¯å®žæ–½ï¼‰

### 1. æ·»åŠ é…ç½®ç¼“å­˜

### 2. ç§»é™¤ä¸å¿…è¦çš„ force-dynamic

### 3. ä¼˜åŒ– API è°ƒç”¨

### 4. æ·»åŠ åŠ è½½çŠ¶æ€

---

## ðŸ“Š é¢„æœŸæ•ˆæžœ

- **é¡µé¢è·³è½¬é€Ÿåº¦**ï¼šæå‡ 50-70%
- **é¦–å±åŠ è½½**ï¼šæå‡ 30-50%
- **API è°ƒç”¨**ï¼šå‡å°‘ 80%ï¼ˆé€šè¿‡ç¼“å­˜ï¼‰

---

## ðŸ”§ å®žæ–½æ­¥éª¤

1. âœ… æ·»åŠ é…ç½®ç¼“å­˜æœºåˆ¶
2. âœ… ä¼˜åŒ–åŠ¨æ€æ¸²æŸ“è®¾ç½®
3. âœ… ä¼˜åŒ– Next.js é…ç½®
4. âœ… æ·»åŠ åŠ è½½çŠ¶æ€ä¼˜åŒ–

